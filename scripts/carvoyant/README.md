# carvoyant connector
## About carvoyant
[carvoyant](http://www.carvoyant.com) is a company that designs and sells a device that turns any vehicle built after 1996 into a connected vehicle. 
Thanks to this device, end users have access to a multitude of data generated by their vehicles.
Moreover, the device's data and services are exposed to developers as REST APIs, which opens up tremendous opportunities.
## Purpose of the scriptr.io connector for carvoyant
The purpose of this connector is to simplify and streamline the way you access carvoyant's APIs from scriptr.io, by providing you with a few native objects that you can directly integrate into your own scripts. 
This will hopefully allow you to create sophisticated applications. For example, using the information about the distance ran by a car and its fuel consumption, you can implement a "pay as you go" car rental
application.
## Components
- carvoyant/user: this is the main object to interact with. It provides access to data of a given user (the one for who you are passing an access token)
- carvoyant/vehicle: you usually obtain an instance of this component from the former. It allows you to obtain all the actions that you can do on a user's vehicle, usually to retrieve data or to subscribe to notifications
- carvoyant/notifications: handles subscriptions to any type of carvoyant notifications, not only vehicle-related. 
Used by the former component but can be used directly.
- carvoyant/common: configuration file to specify the path to notification handlers and notification callbacks.
- carvoyant/mapping: configuration file used for internal purposes.
- carvoyant/util: module with utilily functions used internally.
- carvoyant/client: generic http client that handles the communication between scriptr.io and carvoyant. 
Used by user, vehicle and notifications.
- carvoyant/api/handleEvent: default callback invoked by carvoyant to send notifications to.
- carvoyant/notificationHandlers/DefaultHandler: this is the default handler that is triggered upon the occurrence of any
carvoyant event. 
- carvoyant/test/tests: a list of all the objects and corresponding methods, for examples on how to use them.

## Dependencies
The current library requires you to use the [oauth2 utility library](https://github.com/scriptrdotio/libraries/tree/master/oauth2)
regarding the acquisition of carvoyant authorization tokens for you or your users.

## How to use
- Deploy the aforementioned scripts in your scriptr account, in a folder named "carvoyant".
- Create a developer account and an application at [carvoyant](https://developer.carvoyant.com/member/register).
- Create an end user (driver) account (https://driver.carvoyant.com/)  
- Once done, make sure to copy/paste the values of your Client (Consumer) Key, OAuth 2.0 Client ID and Client (Consumer) Secret in the corresponding
variables of the "oauth2/config file" (respectively client_id and client_secret).
- In the "oauth2/config" file, make sure that the value of the "response_type" variable is set to "token"
- In the "oauth2/config" file, make sure to set the value of the "apiUrl" to the correct carvoyant endpoint (sandbox or production)
- In the "oauth2/config" file, make sure to set the value of the "app" variable to a name you choose
- In the "oauth2/config" file, make sure to leave empty the value of the "apiVer" variable (empty string "")  
- Create a test script in scriptr, or use the script provided in carvoyant/test/. 

### Obtain access tokens from carvoyant

#### Step 1
From a front-end application, send a request to the ```/oauth2/getRequestCodeUrl``` script, passing the ```username``` parameter. 
The username can be the actual end user's carvoyant username or another username he decides to use in your IoT application. 
The result returned by the aforementioned script should resemble the following:

```
>> curl -X POST  -F username=edison -F apsws.time=1434722158021 -H 'Authorization: bearer <YOUR_AUTH_TOKEN>' 'https://api.scriptr.io/oauth2/getRequestCodeUrl'
{
	"metadata": {
		"requestId": "45753a7f-a2b6-4378-a8e1-3bbddced9694",
		"status": "success",
		"statusCode": "200"
	},
	"result": "https://sandbox-auth.carvoyant.com/OAuth/authorize?client_id=atkchwp98j3whpg6cjgwt98h&response_type=token&state=02a0e4&redirect_uri=https%3A%2F%2Fapi.scriptr.io%2Foauth2%2FgetAccessToken%3Fauth_token%3SKzM1RnYwAzc4Mg%3D%3D%26state%3R02a1e4""
}
```
#### Step 2

From the front-end, issue a request to the obtained URL. This redirects your end user to the carovyant login page, 
where he has to enter his credentials then authorize the application on the requested scope. 
Once this is done, carvoyant automatically calls back the ```carvoyant/getAccessToken``` script, providing it with an access and a refresh token
 that it stores in your scriptr.io's global storage. The tokens are also returned by the script.

### Use the connector

In order to use the connector, you need to import the main module: ```carvoyant/user```, as described below:
```
var userModule = require("carvoyant/user");
```
Then create a new instance of the User class, defined in this module (we assume that we already otbained an access token for the given user):
```
var user = new userModule.User({username:"edison"});
```
The User class provides many methods to obtain data related to the end user, such as:
```
var accountsData = user.listAccounts(); // the list of carvoyant accounts owned by this user
var accountDetails = user.getAccount("some_account_id"); // details of a specific carvoyant user account
var vehicles = user.listVehicles(); // lists the vehicles added by this user to his carvoyant accounts
```
In order to manipulate the end user's vehicles, you first need to obtain a reference to the Vehicle class. You can do this:
- by invoking the ```getVehicle(id)``` method of your ```User``` instance, as follows:
```
var vehicle = user.getVehicle("some_id"); // you can easily obtained the vehicles' ids using user.listVehicles()
```
- second option is to create an instance of vehicle, passing a username and a vehicle id:
```
var vehicleModule = require("carvoyant/vehicle");
var vehicle = new vehicleModule.Vehicle({username:"edison", vehicleId:"some_id"});
```
Using the vehicle object, you now retrieve data about the vehicle or subscribe to notifications sent by this latter,
```
var listOfTrips = vehicle.listTrips(); // list the trips done by this vehicle 

// subscribe to harsh accelerations notifications 
var sub = {
  "notificationType": "VEHICLEHARSHACCEL",
  "notificationPeriod": "ONETIME"
};
    
var notification = vehicle.subscribeToNotification(sub);

```

*You can check the list of all available methods using the ```carvoyant/test/tests``` script.*

### About notifications
As mentioned, you can subscribe to notifications that are emitted by a given vehicle, or subscribe to more general notifications 
that relate to the user account (check code documentation of "/carvoyant/notifications") for more on this last part.
By default, carvoyant is instructed by the connector to send notifications to the https://api.scriptr.io/carvoynat/api/handleNotifications API 
that resides in your account. This API's job is to trigger the handler that is configured to process the corresponding notification type.
By default, the "/carvoyant/notifications/DefaultHandler" is invoked for all the notification types. You can implement your own handlers 
and configure what handler to use for what notification type in the "/carvoyant/common" script.
